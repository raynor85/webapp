<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<beans xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.springframework.org/schema/beans" xmlns:jpa="http://www.springframework.org/schema/data/jpa" xmlns:context="http://www.springframework.org/schema/context" xmlns:tx="http://www.springframework.org/schema/tx" xmlns:mvc="http://www.springframework.org/schema/mvc" xmlns:social="http://www.springframework.org/schema/social" xmlns:task="http://www.springframework.org/schema/task" xmlns:util="http://www.springframework.org/schema/util"
	xmlns:cache="http://www.springframework.org/schema/cache"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
						http://www.springframework.org/schema/data/jpa http://www.springframework.org/schema/data/jpa/spring-jpa.xsd
                        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
                        http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd
                        http://www.springframework.org/schema/mvc http://www.springframework.org/schema/mvc/spring-mvc.xsd
						http://www.springframework.org/schema/social http://www.springframework.org/schema/social/spring-social.xsd
						http://www.springframework.org/schema/task http://www.springframework.org/schema/task/spring-task.xsd
						http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd
						http://www.springframework.org/schema/cache http://www.springframework.org/schema/cache/spring-cache.xsd">

	<mvc:annotation-driven />
	<task:annotation-driven />
	<cache:annotation-driven />

	<context:component-scan base-package="com.updapy" />

	<mvc:resources mapping="/robots.txt" location="/robots.txt" order="0" />
	<mvc:resources mapping="/sitemap.xml" location="/sitemap.xml" order="1" />
	<mvc:resources mapping="/favicon.ico" location="/favicon.ico" order="2" />
	<mvc:resources mapping="/resources/**" location="/resources/" order="3" />

	<!-- Cache -->
	<bean id="cacheManager" class="org.springframework.cache.support.SimpleCacheManager">
		<property name="caches">
			<set>
				<bean class="org.springframework.cache.concurrent.ConcurrentMapCacheFactoryBean" name="applications" />
				<bean class="org.springframework.cache.concurrent.ConcurrentMapCacheFactoryBean" name="versions" />
			</set>
		</property>
	</bean>

	<!-- Velocity -->
	<bean id="velocityEngine" class="org.springframework.ui.velocity.VelocityEngineFactoryBean">
		<property name="resourceLoaderPath" value="/WEB-INF/email/" />
	</bean>

	<!-- View resolvers and Tiles -->
	<bean id="tilesViewResolver" class="org.springframework.web.servlet.view.UrlBasedViewResolver">
		<property name="viewClass" value="org.springframework.web.servlet.view.tiles3.TilesView" />
		<property name="order" value="0" />
	</bean>

	<bean id="jspViewResolver" class="org.springframework.web.servlet.view.InternalResourceViewResolver">
		<property name="prefix" value="/WEB-INF/pages/" />
		<property name="suffix" value=".jsp" />
		<property name="order" value="1" />
	</bean>

	<bean id="tilesConfigurer" class="org.springframework.web.servlet.view.tiles3.TilesConfigurer">
		<property name="definitions">
			<list>
				<value>/WEB-INF/tile-defs/tiles.xml</value>
			</list>
		</property>
	</bean>

	<bean id="localeResolver" class="org.springframework.web.servlet.i18n.CookieLocaleResolver">
		<property name="defaultLocale" value="en" />
	</bean>

	<mvc:interceptors>
		<bean class="org.springframework.web.servlet.i18n.LocaleChangeInterceptor">
			<property name="paramName" value="lang" />
		</bean>
	</mvc:interceptors>

	<!-- Repositories -->
	<jpa:repositories base-package="com.updapy.repository" />

	<!-- DB and Transactions -->
	<tx:annotation-driven />
	<bean id="transactionManager" class="org.springframework.orm.jpa.JpaTransactionManager">
		<property name="entityManagerFactory" ref="entityManagerFactory" />
		<property name="dataSource" ref="dataSource" />
	</bean>

	<!-- Dozzer mapper -->
	<bean id="dozerMapper" class="org.dozer.DozerBeanMapper">
		<property name="mappingFiles">
			<list>
				<value>dozer-mapping.xml</value>
			</list>
		</property>
	</bean>

	<!-- Configures social sign in support -->
	<bean id="connectionFactoryLocator" class="org.springframework.social.security.SocialAuthenticationServiceRegistry">
		<property name="authenticationServices">
			<list>
				<bean class="org.springframework.social.facebook.security.FacebookAuthenticationService">
					<constructor-arg value="#{systemEnvironment['FACEBOOK_APP_ID']}" />
					<constructor-arg value="#{systemEnvironment['FACEBOOK_APP_SECRET']}" />
					<property name="defaultScope" value="email" />
				</bean>
				<bean class="org.springframework.social.google.security.GoogleAuthenticationService">
					<constructor-arg value="#{systemEnvironment['GOOGLE_APP_ID']}" />
					<constructor-arg value="#{systemEnvironment['GOOGLE_APP_SECRET']}" />
					<property name="defaultScope" value="email" />
				</bean>
				<bean class="org.springframework.social.linkedin.security.LinkedInAuthenticationService">
					<constructor-arg value="#{systemEnvironment['LINKEDIN_APP_ID']}" />
					<constructor-arg value="#{systemEnvironment['LINKEDIN_APP_SECRET']}" />
				</bean>
			</list>
		</property>
	</bean>
	<social:jdbc-connection-repository /> <!-- Save social connections in database -->

	<!-- Remote retrievers -->
	<util:list id="remoteRetrievers">
		<ref bean="firefoxRemoteRetriever" />
		<ref bean="paintNetRemoteRetriever" />
		<ref bean="notepadPlusPlusRemoteRetriever" />
		<ref bean="gimpRemoteRetriever" />
		<ref bean="adobeReaderRemoteRetriever" />
		<ref bean="vlcMediaPlayerRemoteRetriever" />
		<ref bean="mediaPlayerClassicHcRemoteRetriever" />
		<ref bean="ccleanerRemoteRetriever" />
		<ref bean="filezillaRemoteRetriever" />
		<ref bean="chromiumRemoteRetriever" />
		<ref bean="adobePhotoshopRemoteRetriever" />
		<ref bean="sevenZipRemoteRetriever" />
		<ref bean="thunderbirdRemoteRetriever" />
		<ref bean="pidginRemoteRetriever" />
		<ref bean="kLiteCodecPackRemoteRetriever" />
		<ref bean="songbirdRemoteRetriever" />
		<ref bean="picasaRemoteRetriever" />
		<ref bean="itunesRemoteRetriever" />
		<ref bean="winmergeRemoteRetriever" />
		<ref bean="pdfCreatorRemoteRetriever" />
		<ref bean="avastRemoteRetriever" />
		<ref bean="spybotRemoteRetriever" />
		<ref bean="pdfXchangeViewerRemoteRetriever" />
		<ref bean="mediaPlayerClassicBeRemoteRetriever" />
		<ref bean="xnViewRemoteRetriever" />
		<ref bean="xnViewMpRemoteRetriever" />
		<ref bean="glaryUtilitiesRemoteRetriever" />
		<ref bean="adwCleanerRemoteRetriever" />
		<ref bean="rssOwlRemoteRetriever" />
		<ref bean="slimDriversRemoteRetriever" />
		<ref bean="vmwareWorkstationRemoteRetriever" />
		<ref bean="keePassProRemoteRetriever" />
		<ref bean="yoWindowRemoteRetriever" />
		<ref bean="gmailNotifierProRemoteRetriever" />
		<ref bean="javaReRemoteRetriever" />
		<ref bean="spotifyRemoteRetriever" />
		<ref bean="skypeRemoteRetriever" />
		<ref bean="flashPlayerRemoteRetriever" />
		<ref bean="flashPlayerIeRemoteRetriever" />
		<ref bean="silverlightRemoteRetriever" />
		<ref bean="shockwavePlayerRemoteRetriever" />
		<ref bean="adobeAirRemoteRetriever" />
		<ref bean="eclipseJeeRemoteRetriever" />
		<ref bean="eclipseStandardRemoteRetriever" />
		<ref bean="intellijIdeaUltimateRemoteRetriever" />
		<ref bean="intellijIdeaCommunityRemoteRetriever" />
		<ref bean="sublimeText2RemoteRetriever" />
		<ref bean="balsamiqRemoteRetriever" />
		<ref bean="penguiNetRemoteRetriever" />
		<ref bean="unlockerRemoteRetriever" />
		<ref bean="aviraAntivirusFreeRemoteRetriever" />
		<ref bean="bullzipPdfPrinterCommunityRemoteRetriever" />
		<ref bean="revoUninstallerFreeRemoteRetriever" />
		<ref bean="malwarebytesAntiMalwareFreeRemoteRetriever" />
		<ref bean="squirrelSqlRemoteRetriever" />
		<ref bean="heidiSqlRemoteRetriever" />
		<ref bean="pdfsamRemoteRetriever" />
	</util:list>

	<beans profile="default">

		<!-- Messages and i18n -->
		<bean id="messageSource" class="org.springframework.context.support.ReloadableResourceBundleMessageSource">
			<property name="basenames" value="classpath:i18n/messages,classpath:i18n/validation,classpath:i18n/email,classpath:messages,classpath:project_dev" />
			<property name="defaultEncoding" value="UTF-8" />
		</bean>

		<bean class="java.net.URI" id="dbUrl">
			<constructor-arg value="#{systemEnvironment['DATABASE_URL']}" />
		</bean>

		<bean id="dataSource" class="org.apache.commons.dbcp.BasicDataSource">
			<property name="driverClassName" value="org.postgresql.Driver" />
			<property name="url" value="#{ 'jdbc:postgresql://' + @dbUrl.getHost() + ':' + @dbUrl.getPort() + @dbUrl.getPath() }" />
			<property name="username" value="#{ @dbUrl.getUserInfo().split(':')[0] }" />
			<property name="password" value="#{ @dbUrl.getUserInfo().split(':')[1] }" />
		</bean>

		<bean id="entityManagerFactory" class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean">
			<property name="dataSource" ref="dataSource" />
			<property name="jpaVendorAdapter">
				<bean class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter" />
			</property>
			<property name="jpaProperties">
				<props>
					<prop key="hibernate.dialect">org.hibernate.dialect.PostgreSQLDialect</prop>
					<prop key="hibernate.show_sql">true</prop>
					<prop key="hibernate.format_sql">true</prop>
					<prop key="hibernate.hbm2ddl.import_files">/sql/import.sql</prop>
					<prop key="hibernate.hbm2ddl.auto">validate</prop>
				</props>
			</property>
		</bean>
	</beans>

	<beans profile="prod">

		<!-- Messages and i18n -->
		<bean id="messageSource" class="org.springframework.context.support.ReloadableResourceBundleMessageSource">
			<property name="basenames" value="classpath:i18n/messages,classpath:i18n/validation,classpath:i18n/email,classpath:messages,classpath:project_prod" />
			<property name="defaultEncoding" value="UTF-8" />
		</bean>

		<bean class="java.net.URI" id="dbUrl">
			<constructor-arg value="#{systemEnvironment['DATABASE_URL']}" />
		</bean>

		<bean id="dataSource" class="org.apache.commons.dbcp.BasicDataSource">
			<property name="url" value="#{ 'jdbc:postgresql://' + @dbUrl.getHost() + ':' + @dbUrl.getPort() + @dbUrl.getPath() }" />
			<property name="username" value="#{ @dbUrl.getUserInfo().split(':')[0] }" />
			<property name="password" value="#{ @dbUrl.getUserInfo().split(':')[1] }" />
		</bean>

		<bean id="entityManagerFactory" class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean">
			<property name="dataSource" ref="dataSource" />
			<property name="jpaVendorAdapter">
				<bean class="org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter" />
			</property>
			<property name="jpaProperties">
				<props>
					<prop key="hibernate.dialect">org.hibernate.dialect.PostgreSQLDialect</prop>
					<prop key="hibernate.show_sql">false</prop>
					<prop key="hibernate.hbm2ddl.auto">validate</prop>
				</props>
			</property>
		</bean>
	</beans>

</beans>
